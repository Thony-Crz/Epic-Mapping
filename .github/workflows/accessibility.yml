name: Tests d'AccessibilitÃ© WCAG

on:
  # DÃ©clenchement manuel UNIQUEMENT
  workflow_dispatch:
    inputs:
      browser:
        description: 'Navigateur pour les tests'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      test_file:
        description: 'Fichier de test spÃ©cifique (optionnel)'
        required: false
        type: string
      environment:
        description: 'Environnement Ã  tester'
        required: false
        default: 'local-build'
        type: choice
        options:
          - local-build
          - production

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  accessibility-audit:
    name: Audit d'AccessibilitÃ© WCAG 2.1 AA
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: ${{ github.event.inputs.browser == 'all' && fromJson('["chromium", "firefox", "webkit"]') || fromJson(format('["{0}"]', github.event.inputs.browser || 'chromium')) }}
    
    defaults:
      run:
        working-directory: ./frontEnd
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontEnd/package-lock.json'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
      
      - name: ğŸ§ª Run accessibility tests
        run: |
          if [ -n "${{ github.event.inputs.test_file }}" ]; then
            npx playwright test accessibility/${{ github.event.inputs.test_file }} --config=e2e/accessibility.config.ts --project=accessibility-${{ matrix.browser }}
          else
            npx playwright test --config=e2e/accessibility.config.ts --project=accessibility-${{ matrix.browser }}
          fi
        continue-on-error: true
      
      - name: ğŸ“Š Generate accessibility report summary
        if: always()
        run: |
          echo "# ğŸ” Rapport d'AccessibilitÃ© - ${{ matrix.browser }}" > accessibility-summary.md
          echo "" >> accessibility-summary.md
          
          if [ -f "accessibility-results.json" ]; then
            # Extraire les statistiques du JSON
            TOTAL=$(cat accessibility-results.json | jq -r '.stats.total // 0')
            PASSED=$(cat accessibility-results.json | jq -r '.stats.expected // 0')
            FAILED=$(cat accessibility-results.json | jq -r '.stats.unexpected // 0')
            SKIPPED=$(cat accessibility-results.json | jq -r '.stats.skipped // 0')
            
            if [ "$TOTAL" -gt 0 ]; then
              SUCCESS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
            else
              SUCCESS_RATE="0"
            fi
            
            echo "## ğŸ“ˆ Statistiques Globales" >> accessibility-summary.md
            echo "- **Tests exÃ©cutÃ©s :** $TOTAL" >> accessibility-summary.md
            echo "- **Tests rÃ©ussis :** $PASSED" >> accessibility-summary.md
            echo "- **Tests Ã©chouÃ©s :** $FAILED" >> accessibility-summary.md
            echo "- **Tests ignorÃ©s :** $SKIPPED" >> accessibility-summary.md
            echo "- **Taux de rÃ©ussite :** ${SUCCESS_RATE}%" >> accessibility-summary.md
            echo "" >> accessibility-summary.md
            
            # Ã‰valuation du niveau d'accessibilitÃ©
            if (( $(echo "$SUCCESS_RATE >= 95" | bc -l) )); then
              echo "## âœ… Niveau d'AccessibilitÃ© : EXCELLENT" >> accessibility-summary.md
              echo "Votre application respecte remarquablement les standards WCAG 2.1 AA !" >> accessibility-summary.md
            elif (( $(echo "$SUCCESS_RATE >= 85" | bc -l) )); then
              echo "## ğŸŸ¢ Niveau d'AccessibilitÃ© : TRÃˆS BON" >> accessibility-summary.md
              echo "Votre application est bien accessible avec quelques amÃ©liorations mineures possibles." >> accessibility-summary.md
            elif (( $(echo "$SUCCESS_RATE >= 70" | bc -l) )); then
              echo "## ğŸŸ¡ Niveau d'AccessibilitÃ© : BON" >> accessibility-summary.md
              echo "Votre application est accessible mais des amÃ©liorations sont recommandÃ©es." >> accessibility-summary.md
            elif (( $(echo "$SUCCESS_RATE >= 50" | bc -l) )); then
              echo "## ğŸŸ  Niveau d'AccessibilitÃ© : MOYEN" >> accessibility-summary.md
              echo "Des corrections importantes sont nÃ©cessaires pour amÃ©liorer l'accessibilitÃ©." >> accessibility-summary.md
            else
              echo "## ğŸ”´ Niveau d'AccessibilitÃ© : INSUFFISANT" >> accessibility-summary.md
              echo "Des corrections majeures sont requises pour respecter les standards WCAG." >> accessibility-summary.md
            fi
            
            echo "" >> accessibility-summary.md
            echo "## ğŸ¯ Standards WCAG VÃ©rifiÃ©s" >> accessibility-summary.md
            echo "- âœ… Niveau A : AccessibilitÃ© de base" >> accessibility-summary.md
            echo "- âœ… Niveau AA : AccessibilitÃ© standard (requis)" >> accessibility-summary.md
            echo "- ğŸ” Contraste des couleurs (4.5:1)" >> accessibility-summary.md
            echo "- ğŸ” Navigation au clavier" >> accessibility-summary.md
            echo "- ğŸ” Textes alternatifs" >> accessibility-summary.md
            echo "- ğŸ” Formulaires accessibles" >> accessibility-summary.md
            echo "- ğŸ” Structure sÃ©mantique" >> accessibility-summary.md
            
          else
            echo "âŒ Aucun rÃ©sultat de test trouvÃ©" >> accessibility-summary.md
          fi
      
      - name: ğŸ“ Upload accessibility artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report-${{ matrix.browser }}
          path: |
            ./frontEnd/accessibility-report/
            ./frontEnd/accessibility-results.json
            ./frontEnd/accessibility-summary.md
            ./frontEnd/test-results/
          retention-days: 30
      
      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const path = './frontEnd/accessibility-summary.md';
            
            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');
              
              const comment = `${summary}
              
              ---
              
              ğŸ“‹ **Artefacts disponibles :**
              - Rapport HTML interactif
              - RÃ©sultats JSON dÃ©taillÃ©s  
              - Screenshots des Ã©checs
              
              ğŸ’¡ **Rappel :** Ces tests d'accessibilitÃ© sont informatifs et aident Ã  maintenir la conformitÃ© WCAG 2.1 AA.
              
              ğŸ”— [Voir tous les artefacts](${context.payload.pull_request.html_url}/checks)`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  accessibility-summary:
    name: RÃ©sumÃ© Global d'AccessibilitÃ©
    runs-on: ubuntu-latest
    needs: accessibility-audit
    if: always()
    
    steps:
      - name: ğŸ“¥ Download all accessibility reports
        uses: actions/download-artifact@v4
        with:
          pattern: accessibility-report-*
          merge-multiple: true
          path: ./accessibility-reports
      
      - name: ğŸ“Š Create global summary
        run: |
          echo "# ğŸŒ Rapport Global d'AccessibilitÃ© WCAG" > global-summary.md
          echo "" >> global-summary.md
          echo "## ğŸ—“ï¸ ExÃ©cutÃ© le : $(date '+%Y-%m-%d %H:%M:%S UTC')" >> global-summary.md
          echo "## ğŸ”— Commit : ${{ github.sha }}" >> global-summary.md
          echo "" >> global-summary.md
          
          for browser in chromium firefox webkit; do
            if [ -f "./accessibility-reports/accessibility-summary.md" ]; then
              echo "### ğŸŒ RÃ©sultats pour $browser" >> global-summary.md
              cat "./accessibility-reports/accessibility-summary.md" >> global-summary.md
              echo "" >> global-summary.md
            fi
          done
          
          echo "## ğŸ› ï¸ Actions RecommandÃ©es" >> global-summary.md
          echo "1. **Corrigez les erreurs critiques** identifiÃ©es dans les rapports" >> global-summary.md
          echo "2. **Testez manuellement** avec un lecteur d'Ã©cran (NVDA, JAWS)" >> global-summary.md
          echo "3. **VÃ©rifiez la navigation** uniquement au clavier" >> global-summary.md
          echo "4. **Validez les contrastes** dans vos outils de design" >> global-summary.md
          echo "5. **Documentez** les exceptions justifiÃ©es" >> global-summary.md
          echo "" >> global-summary.md
          echo "## ğŸ“š Ressources" >> global-summary.md
          echo "- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)" >> global-summary.md
          echo "- [Guide d'accessibilitÃ© du projet](./frontEnd/accessibility/README.md)" >> global-summary.md
          echo "- [DÃ©marrage rapide](./frontEnd/ACCESSIBILITY-QUICKSTART.md)" >> global-summary.md
      
      - name: ğŸ“ Upload global summary
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-global-summary
          path: global-summary.md
          retention-days: 90
